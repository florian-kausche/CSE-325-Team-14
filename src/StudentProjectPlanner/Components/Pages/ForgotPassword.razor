@page "/forgot-password"
@layout Layout.AuthLayout
@using System.Collections.Generic
@using System.ComponentModel.DataAnnotations
@using System.Text
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using StudentProjectPlanner.Models
@using StudentProjectPlanner.Services.Interfaces
@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender EmailSender
@inject NavigationManager Navigation

<PageTitle>Forgot Password - Student Project Planner</PageTitle>

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-card-header auth-header-primary">
            <div class="auth-logo">
                <i class="bi bi-shield-lock-fill"></i>
            </div>
            <h2>Reset Password</h2>
            <p>We'll email you a reset link</p>
        </div>
        <div class="auth-card-body">
            @if (!string.IsNullOrEmpty(StatusMessage))
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-1"></i> @StatusMessage
                </div>
            }

            <EditForm Model="Input" OnValidSubmit="HandleSubmit" FormName="ForgotPasswordForm">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <div class="mb-4">
                    <label class="form-label">Email Address</label>
                    <div class="input-icon-wrapper">
                        <i class="bi bi-envelope input-icon"></i>
                        <InputText class="form-control form-control-icon" @bind-Value="Input.Email"
                                   placeholder="name@example.com" />
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100" disabled="@IsSubmitting">
                    <i class="bi bi-send me-1"></i> Send Reset Link
                </button>
            </EditForm>

            <div class="auth-divider"></div>
            <p class="text-center mb-0 auth-footer-text">
                Remembered your password? <a href="/login" class="auth-link">Sign in</a>
            </p>
        </div>
    </div>
</div>

@code {
    private readonly string _genericMessage = "If an account exists for that email, a reset link has been sent.";

    private ForgotPasswordModel Input { get; set; } = new();

    private string? StatusMessage { get; set; }

    private bool IsSubmitting { get; set; }

    private async Task HandleSubmit()
    {
        IsSubmitting = true;
        StatusMessage = null;

        try
        {
            var user = await UserManager.FindByEmailAsync(Input.Email);
            if (user != null)
            {
                var token = await UserManager.GeneratePasswordResetTokenAsync(user);
                var encodedToken = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(token));

                var resetUrl = QueryHelpers.AddQueryString(
                    $"{Navigation.BaseUri}reset-password",
                    new Dictionary<string, string?>
                    {
                        ["email"] = Input.Email,
                        ["token"] = encodedToken
                    });

                var body = $"Use the link below to reset your password:\n{resetUrl}";
                await EmailSender.SendEmailAsync(Input.Email, "Reset your password", body);
            }

            StatusMessage = _genericMessage;
            Input = new ForgotPasswordModel();
        }
        catch (Exception)
        {
            StatusMessage = "Unable to send reset email right now. Please try again later.";
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private class ForgotPasswordModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Please enter a valid email address")]
        public string Email { get; set; } = string.Empty;
    }
}
