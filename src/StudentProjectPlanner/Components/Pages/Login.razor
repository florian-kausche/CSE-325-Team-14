@page "/login"
@layout Layout.AuthLayout
@using Microsoft.AspNetCore.Identity
@using StudentProjectPlanner.Models
@using System.ComponentModel.DataAnnotations
@inject SignInManager<ApplicationUser> SignInManager
@inject NavigationManager Navigation

<PageTitle>Login - Student Project Planner</PageTitle>

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-card-header auth-header-primary">
            <div class="auth-logo">
                <i class="bi bi-mortarboard-fill"></i>
            </div>
            <h2>Welcome Back</h2>
            <p>Sign in to your account</p>
        </div>
        <div class="auth-card-body">
            @if (Reset == "1")
            {
                <div class="alert alert-success">
                    <i class="bi bi-check-circle-fill me-1"></i> Password reset successful. Please sign in.
                </div>
            }

            @if (!string.IsNullOrEmpty(ErrorMessage))
            {
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i> @ErrorMessage
                </div>
            }

            <EditForm Model="LoginInput" OnValidSubmit="HandleLogin" FormName="LoginForm">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <div class="mb-4">
                    <label class="form-label">Email Address</label>
                    <div class="input-icon-wrapper">
                        <i class="bi bi-envelope input-icon"></i>
                        <InputText class="form-control form-control-icon" @bind-Value="LoginInput.Email"
                                   placeholder="name@example.com" />
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label">Password</label>
                    <div class="input-icon-wrapper">
                        <i class="bi bi-lock input-icon"></i>
                        <InputText type="password" class="form-control form-control-icon" @bind-Value="LoginInput.Password"
                                   placeholder="Enter your password" />
                    </div>
                </div>

                <div class="mb-4 form-check">
                    <InputCheckbox class="form-check-input" @bind-Value="LoginInput.RememberMe" />
                    <label class="form-check-label">Remember me for 30 days</label>
                </div>

                <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="bi bi-box-arrow-in-right me-1"></i> Sign In
                </button>
            </EditForm>

            <div class="text-end mt-3">
                <a href="/forgot-password" class="auth-link">Forgot password?</a>
            </div>

            <div class="auth-divider"></div>
            <p class="text-center mb-0 auth-footer-text">
                Don't have an account? <a href="/register" class="auth-link">Create one</a>
            </p>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private LoginModel LoginInput { get; set; } = new();

    [SupplyParameterFromQuery]
    private string? ReturnUrl { get; set; }

    [SupplyParameterFromQuery]
    private string? Reset { get; set; }

    private string? ErrorMessage { get; set; }

    private async Task HandleLogin()
    {
        try
        {
            var result = await SignInManager.PasswordSignInAsync(
                LoginInput.Email,
                LoginInput.Password,
                LoginInput.RememberMe,
                lockoutOnFailure: false);

            if (result.Succeeded)
            {
                Navigation.NavigateTo(ReturnUrl ?? "/", true);
            }
            else
            {
                ErrorMessage = "Invalid email or password. Please try again.";
            }
        }
        catch (Microsoft.AspNetCore.Components.NavigationException)
        {
            throw; // Let Blazor handle the redirect
        }
        catch (Exception)
        {
            ErrorMessage = "An error occurred while signing in. Please try again.";
        }
    }

    private class LoginModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Please enter a valid email address")]
        public string Email { get; set; } = string.Empty;

        [Required(ErrorMessage = "Password is required")]
        [DataType(DataType.Password)]
        public string Password { get; set; } = string.Empty;

        public bool RememberMe { get; set; }
    }
}
