@page "/reset-password"
@layout Layout.AuthLayout
@using System.ComponentModel.DataAnnotations
@using System.Linq
@using System.Text
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using StudentProjectPlanner.Models
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Navigation

<PageTitle>Reset Password - Student Project Planner</PageTitle>

<div class="auth-container">
    <div class="auth-card">
        <div class="auth-card-header auth-header-success">
            <div class="auth-logo">
                <i class="bi bi-key-fill"></i>
            </div>
            <h2>Set a New Password</h2>
            <p>Choose a strong password</p>
        </div>
        <div class="auth-card-body">
            @if (!string.IsNullOrEmpty(StatusMessage))
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill me-1"></i> @StatusMessage
                </div>
            }

            @if (IsTokenValid)
            {
                <EditForm Model="Input" OnValidSubmit="HandleSubmit" FormName="ResetPasswordForm">
                    <DataAnnotationsValidator />
                    <ValidationSummary class="text-danger" />

                    <div class="mb-4">
                        <label class="form-label">New Password</label>
                        <div class="input-icon-wrapper">
                            <i class="bi bi-lock input-icon"></i>
                            <InputText type="password" class="form-control form-control-icon" @bind-Value="Input.Password"
                                       placeholder="Enter a new password" />
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label">Confirm Password</label>
                        <div class="input-icon-wrapper">
                            <i class="bi bi-lock-fill input-icon"></i>
                            <InputText type="password" class="form-control form-control-icon" @bind-Value="Input.ConfirmPassword"
                                       placeholder="Confirm your password" />
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success btn-lg w-100" disabled="@IsSubmitting">
                        <i class="bi bi-check-circle me-1"></i> Reset Password
                    </button>
                </EditForm>
            }

            <div class="auth-divider"></div>
            <p class="text-center mb-0 auth-footer-text">
                Return to <a href="/login" class="auth-link">Sign in</a>
            </p>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    private string? Email { get; set; }

    [SupplyParameterFromQuery]
    private string? Token { get; set; }

    private ResetPasswordModel Input { get; set; } = new();

    private string? StatusMessage { get; set; }

    private bool IsSubmitting { get; set; }

    private bool IsTokenValid { get; set; } = true;

    private string? DecodedToken { get; set; }

    protected override void OnParametersSet()
    {
        if (string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(Token))
        {
            IsTokenValid = false;
            StatusMessage = "Invalid or missing reset token.";
            return;
        }

        try
        {
            var bytes = WebEncoders.Base64UrlDecode(Token);
            DecodedToken = Encoding.UTF8.GetString(bytes);
        }
        catch (FormatException)
        {
            IsTokenValid = false;
            StatusMessage = "Invalid or expired reset token.";
        }
    }

    private async Task HandleSubmit()
    {
        if (!IsTokenValid || string.IsNullOrWhiteSpace(DecodedToken))
        {
            StatusMessage = "Invalid or expired reset token.";
            return;
        }

        if (Input.Password != Input.ConfirmPassword)
        {
            StatusMessage = "Passwords do not match.";
            return;
        }

        IsSubmitting = true;
        StatusMessage = null;

        try
        {
            var user = await UserManager.FindByEmailAsync(Email!);
            if (user == null)
            {
                StatusMessage = "Unable to reset the password. Please request a new reset link.";
                return;
            }

            var result = await UserManager.ResetPasswordAsync(user, DecodedToken, Input.Password);
            if (result.Succeeded)
            {
                Navigation.NavigateTo("/login?reset=1", true);
                return;
            }

            StatusMessage = string.Join(" ", result.Errors.Select(error => error.Description));
        }
        catch (Exception)
        {
            StatusMessage = "Unable to reset the password right now. Please try again later.";
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private class ResetPasswordModel
    {
        [Required(ErrorMessage = "Password is required")]
        [DataType(DataType.Password)]
        public string Password { get; set; } = string.Empty;

        [Required(ErrorMessage = "Confirm password is required")]
        [DataType(DataType.Password)]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}
